\section{Introduction}
In this chapter we analyze the motivations that leaded to this work, in particular we analyze the current problems in the NoSQL service implementation of CPIM and propose a solution to address them and at the same time extending the number of NoSQL database supported by the library.
\noindent Furthermore we will analyze why we decided to include the possibility for the user of the CPIM library to be able to migrate and synchronize data with the \textit{Hegira} migration and synchronization system.

\section{CPIM NoSQL service}
CPIM is using JPA interface to ease the communication to different NoSQL databases. There exists some limitation in this approach, a first limitation is that as the NoSQL service is implemented, is not possible to choose a different NoSQL service with respect to the chosen cloud provider. For example, if Google App Engine is the PaaS on which the application will deployed, the only possible NoSQL solution available is Datastore, the NoSQL solution available in the App Engine environment.
We would give to the user the ability to persist data in the database that best fit his requirements. For example if the user application will generate data that will be processed with Hadoop, the best solution is to store those data in an HBase instance since its integrate easily in Hadoop.
Therefore we want to make the user able to persist different entities in different datastore based on his needs and without the limitation of a specific NoSQL technology.

\newparagraph Another problem the current JPA implementation of the NoSQL service of CPIM is that is not perfectly transparent to the underlying database. The problem reside in the fact that for each of the currently supported database has been found, and integrated into CPIM, a specific implementation of the JPA interface. Even through JPA is a well defined standard, not every JPA provider follows strictly the specification and thus different provider can behave differently while persisting the same entities since they interpret differently the semantic of some JPA annotation.

\noindent An example of this problem is how Collection fields are currently handled in CPIM. In the Google JPA implementation for Datastore and in the JPA implementation for Amazon SimpleDB, Collection fields are handled correctly, with respect to the JPA specification, thought the \texttt{@ElementCollection} annotation, while, in the JPA implementation for Azure Tables, Collection fields needs to be annotated with the \texttt{@Embedded} annotation. This require a modification of the code and thus eliminates the effort of CPIM in achieving code portability among PaaS.

\newparagraph Beside the problems by which the current NoSQL implementation of CPIM suffer, we want to go further and extends the number of NoSQL databases that the CPIM can interacts with.

\noindent The proposed solution is to user Kundera as unique persistence layer for the NoSQL service. This integration will produce several benefits to the NoSQL service of CPIM resolving the previously stated problems:
\begin{itemize}
\item since Kundera will be the unique persistence provider for the library we will relay only on one implementation of the JPA interface overtaking the problems related to different interpretation of the JPA annotation and thus achieving complete portability of the code of the model since no modifications are required to work with different NoSQL database through Kundera;
\item the integration of Kundera permits a redesign of the NoSQL service aimed to decouple the chosen PaaS provider and the NoSQL technology giving to the user the ability to decide which technology is more suitable for his needs. Furthermore exploiting the polyglot-persistence provided by Kundera, the user will be able to persist entities within different NoSQL databases at the same time simply by define accordingly the persistence unit in the \textit{persistence.xml} file;
\item choosing Kundera as persistence layer we can actually take advantage of the already developed extension for many different NoSQL databases adding as a result the support of those database to CPIM;
\end{itemize}

\noindent There are other reasons why we choose to use Kundera as persistence provider for the NoSQL service of CPIM. The main reason is that Kundera, through the use of the JPA interface will permit to the user to handle the complexity of NoSQL databases with expertise he already uses for SQL systems.
Furthermore Kundera is in the field from 2010 so have a big and active community, built in many years of activity, and has been used successfully in some production environment.

\noindent The only drawback is that Kundera does not support any of the NoSQL datastore currently supported by CPIM; here comes one more reason by which we choose Kundera. Kundera have as its primary goal to make the library as much extensible as possible to let developers build their own client around new NoSQL technology. The solution will thus be to develop the needed extensions for Kundera.

\newparagraph In this ambit the work roadmap is the following:
\begin{itemize}
\item refactor the NoSQL architecture of CPIM to integrate Kundera as the unique persistence provider;
\item develop two brand new Kundera extensions, one for Google Datastore and one for Azure Tables.
\end{itemize}

\section{Hegira integration}
NoSQL technologies do not offer a common language for interaction as SQL is for DBMS, furthermore they offer a simpler interface with respect to DBMS. This require user to interact with NoSQL databases at a lower level of interaction, moreover no effort is made by NoSQL database in hiding to the user the physical representation of the data, this move a good amount of developing effort toward the user.
This approach, and the many different NoSQL solution available nowadays, causes a lock-in on the technology chosen since re-engineer an application is often an operation with huge costs for companies.

\newparagraph To mitigate this lock-in problem we want to extend CPIM to make it able to interact with \textit{Hegira} a migration system able to perform interoperable data migration and synchronization across column-based NoSQL databases \cite{paper:modaclouds-deliverable}.

\noindent \textit{Hegira} is already able to migrate data offline but in many cases this solution is not acceptable since this require to turn off the application for a period of time that depends on how many data needs to be migrated to the new database. 
Downtime cost and risk of data loss can be problematic so \textit{Hegira} was extended to be able to perform a live-migration of the data by keeping them synchronized on the source and the destination database.
This feature needs to be exploited at application level and thus we decide to embed it inside the CPIM NoSQL service in order to make it as transparent as possible to the user.

\noindent CPIM needs to be aware of the state of both the synchronization and migration systems and acts accordingly intercepting user operation and sending data manipulation queries (DMQ) to the migration system wile keeping the data synchronized interacting with the synchronization system when required.